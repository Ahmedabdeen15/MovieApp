<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieApp - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <meta name="theme-color" content="#712cf9">
    <link rel="stylesheet" href="main.css">
    <style>
        .movie-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .movie-card:hover {
            transform: scale(1.05);
        }
        .movie-poster {
            height: 300px;
            object-fit: cover;
        }
        .loading-spinner {
            display: none;
        }
        .search-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="bg-body-tertiary">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-film me-2" viewBox="0 0 16 16">
                    <path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm4 0v6h8V1zm8 8H4v6h8zM1 1v2h2V1zm2 3H1v2h2zM1 7v2h2V7zm2 3H1v2h2zm-2 3v2h2v-2zM15 1h-2v2h2zm-2 3v2h2V4zm2 3h-2v2h2zm-2 3v2h2v-2zm2 3h-2v2h2z"/>
                </svg>
                MovieApp
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Search Section -->
    <section class="search-section">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <h1 class="text-center text-white mb-4">🎬 Discover Amazing Movies</h1>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search for movies...">
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                            Search
                        </button>
                    </div>
                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                        <button class="btn btn-outline-light btn-sm" onclick="loadTopRated()">Top Rated</button>
                        <button class="btn btn-outline-light btn-sm" onclick="loadByYear(2023)">2023 Movies</button>
                        <button class="btn btn-outline-light btn-sm" onclick="loadByRating(8.0)">High Rated (8+)</button>
                        <button class="btn btn-outline-light btn-sm" onclick="loadByYear(2022)">2022 Movies</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="container">
        <!-- Loading Spinner -->
        <div class="text-center loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading movies...</p>
        </div>

        <!-- Movies Grid -->
        <div class="row" id="moviesGrid">
            <!-- Movies will be loaded here -->
        </div>

        <!-- Load More Button -->
        <div class="text-center mt-4 mb-4" id="loadMoreSection" style="display: none;">
            <button class="btn btn-primary" id="loadMoreBtn" onclick="loadMoreMovies()">
                Load More Movies
            </button>
        </div>

        <!-- Stats Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">📊 Movie Statistics</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="totalMovies">0</h4>
                                    <small class="text-muted">Total Movies</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="totalPages">0</h4>
                                    <small class="text-muted">Pages Loaded</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="avgRating">0.0</h4>
                                    <small class="text-muted">Avg Rating</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 id="currentFilter">All</h4>
                                    <small class="text-muted">Current Filter</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    
    <!-- Custom JS -->
    <script type="module">
        import { movieService } from './main.js';

        // Global variables
        let currentPage = 1;
        let currentFilter = 'topRated';
        let currentFilterParam = null;
        let allMovies = [];
        let isLoading = false;

        // DOM elements
        const moviesGrid = document.getElementById('moviesGrid');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadMoreSection = document.getElementById('loadMoreSection');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadTopRated();
            setupEventListeners();
        });

        function setupEventListeners() {
            searchBtn.addEventListener('click', () => {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchMovies(searchTerm);
                }
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }

        async function loadTopRated() {
            await loadMovies('topRated', 1, 2);
        }

        async function loadByYear(year) {
            await loadMovies('year', 1, 2, year);
        }

        async function loadByRating(rating) {
            await loadMovies('rating', 1, 2, rating);
        }

        async function searchMovies(searchTerm) {
            await loadMovies('search', 1, 2, searchTerm);
        }

        async function loadMoreMovies() {
            if (isLoading) return;
            
            currentPage++;
            await loadMovies(currentFilter, currentPage, 1, currentFilterParam);
        }

        async function loadMovies(filterType, page, pageCount, param = null) {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                let moviePages;
                
                switch (filterType) {
                    case 'topRated':
                        moviePages = await movieService.getMoviePagesOnDemand(page, pageCount);
                        currentFilter = 'topRated';
                        currentFilterParam = null;
                        break;
                    case 'search':
                        moviePages = await movieService.getMoviePagesBySearchOnDemand(param, pageCount);
                        currentFilter = 'search';
                        currentFilterParam = param;
                        break;
                    case 'year':
                        moviePages = await movieService.getMoviePagesByYearOnDemand(param, pageCount);
                        currentFilter = 'year';
                        currentFilterParam = param;
                        break;
                    case 'rating':
                        moviePages = await movieService.getMoviePagesByRatingOnDemand(param, pageCount);
                        currentFilter = 'rating';
                        currentFilterParam = param;
                        break;
                    default:
                        moviePages = await movieService.getMoviePagesOnDemand(page, pageCount);
                }

                // If it's a new filter, clear the grid
                if (page === 1) {
                    allMovies = [];
                    moviesGrid.innerHTML = '';
                }

                // Add movies to the array
                moviePages.forEach(page => {
                    allMovies.push(...page.movieList);
                });

                // Display movies
                displayMovies(moviePages);
                updateStats();
                
                // Show/hide load more button
                loadMoreSection.style.display = moviePages.length > 0 ? 'block' : 'none';
                
            } catch (error) {
                console.error('Error loading movies:', error);
                showError('Failed to load movies. Please try again.');
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        function displayMovies(moviePages) {
            moviePages.forEach(page => {
                page.movieList.forEach(movie => {
                    const movieCard = createMovieCard(movie);
                    moviesGrid.appendChild(movieCard);
                });
            });
        }

        function createMovieCard(movie) {
            const col = document.createElement('div');
            col.className = 'col-md-3 col-lg-2 mb-4';
            
            const posterPath = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w500${movie.poster_path}`
                : 'https://via.placeholder.com/300x450/666/fff?text=No+Image';
            
            col.innerHTML = `
                <div class="card movie-card h-100">
                    <img src="${posterPath}" class="card-img-top movie-poster" alt="${movie.title}">
                    <div class="card-body">
                        <h6 class="card-title">${movie.title}</h6>
                        <p class="card-text small text-muted">${movie.release_date ? new Date(movie.release_date).getFullYear() : 'N/A'}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-warning text-dark">⭐ ${movie.vote_average?.toFixed(1) || 'N/A'}</span>
                            <small class="text-muted">${movie.vote_count || 0} votes</small>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            // Create error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at the top of the container
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function updateStats() {
            const totalMovies = allMovies.length;
            const totalPages = Math.ceil(totalMovies / 20); // Assuming 20 movies per page
            const avgRating = allMovies.length > 0 
                ? (allMovies.reduce((sum, movie) => sum + (movie.vote_average || 0), 0) / allMovies.length).toFixed(1)
                : '0.0';
            
            document.getElementById('totalMovies').textContent = totalMovies;
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('currentFilter').textContent = getFilterDisplayName(currentFilter);
        }

        function getFilterDisplayName(filter) {
            switch (filter) {
                case 'topRated': return 'Top Rated';
                case 'search': return `Search: ${currentFilterParam}`;
                case 'year': return `${currentFilterParam} Movies`;
                case 'rating': return `Rating ≥ ${currentFilterParam}`;
                default: return 'All';
            }
        }

        // Make functions globally available for onclick handlers
        window.loadTopRated = loadTopRated;
        window.loadByYear = loadByYear;
        window.loadByRating = loadByRating;
        window.loadMoreMovies = loadMoreMovies;
    </script>
</body>

</html>